<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šå‹•æ…‹ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #212529;
            --text-sub: #6c757d;
            --timeline-line: #dee2e6;
            --highlight: #0d6efd;
            --passed: #adb5bd;
            --line-color: #06c755;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --card-bg: #1e1e1e;
                --text-main: #e0e0e0;
                --text-sub: #a0a0a0;
                --timeline-line: #404040;
                --highlight: #6ea8fe;
                --passed: #4a4a4a;
            }
            .modal-content { background-color: #2b2b2b; color: #e0e0e0; }
            .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main);
            padding-bottom: 100px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .card {
            background-color: var(--card-bg);
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            border-radius: 16px;
        }

        .form-control, .form-select, .btn {
            border-radius: 12px; height: 45px; font-size: 16px;
        }

        .btn-line {
            background-color: var(--line-color); color: white; border: none; font-weight: bold;
        }
        .btn-line:hover { background-color: #05b34c; color: white; }

        /* Sticky Header */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 12px 15px; margin: 0 -12px 15px -12px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 0 0 16px 16px;
            display: none;
        }
        @media (prefers-color-scheme: dark) {
            .sticky-header {
                background-color: rgba(30, 30, 30, 0.85);
                border-bottom: 1px solid rgba(255,255,255,0.05);
            }
        }

        /* åº•éƒ¨è³‡è¨Šåˆ— (æ–°ç‰ˆæ¨£å¼) */
        .footer-info {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); padding: 8px 10px;
            font-size: 0.75rem; text-align: center;
            border-top: 1px solid var(--timeline-line);
            color: var(--text-main); z-index: 100;
            display: flex; justify-content: center; gap: 8px; align-items: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .footer-divider { color: var(--text-sub); opacity: 0.5; }

        /* FAB */
        .fab-container { position: fixed; bottom: 45px; right: 20px; z-index: 1050; display: none; }
        .fab-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background-color: var(--card-bg); color: var(--highlight);
            border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s; position: relative;
        }
        .fab-btn:active { transform: scale(0.95); }
        .fab-btn.active { background-color: var(--highlight); color: white; }
        .fab-badge {
            position: absolute; top: 0; right: 0; width: 15px; height: 15px;
            background-color: #dc3545; border-radius: 50%;
            border: 2px solid var(--card-bg); display: none;
        }

        /* Timeline */
        .timeline-container { position: relative; padding-left: 20px; }
        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 35px; border-left: 2px solid var(--timeline-line); }
        .timeline-item:last-child { border-left: transparent; }
        
        .timeline-dot {
            position: absolute; left: -6px; top: 5px;
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--card-bg); border: 2px solid var(--timeline-line);
            transition: all 0.3s;
        }
        .timeline-item.passed { border-left-color: var(--timeline-line); }
        .timeline-item.passed .timeline-dot { background: var(--passed); border-color: var(--passed); }
        .timeline-item.passed .text-main { color: var(--passed); text-decoration: line-through; }
        
        .timeline-item.active .timeline-dot { 
            width: 16px; height: 16px; left: -9px; top: 2px;
            background: var(--highlight); border-color: var(--highlight);
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.4);
        }
        .timeline-item.active .text-main { font-weight: bold; color: var(--highlight); font-size: 1.15rem; }

        .delay-tag { 
            font-size: 0.75rem; padding: 4px 8px; border-radius: 20px; font-weight: bold;
            display: inline-block; margin-left: 8px;
        }
        .bg-delay-ok { background-color: #d1e7dd; color: #0f5132; }
        .bg-delay-bad { background-color: #f8d7da; color: #842029; }
        .bg-not-started { background-color: #e2e3e5; color: #41464b; }
        
        .text-main { color: var(--text-main); }
        .text-sub { color: var(--text-sub); }
    </style>
</head>
<body>

<div class="container mt-3" style="max-width: 600px;">
    <div class="card p-3">
        <h4 class="mb-3 fw-bold">ğŸš„ åˆ—è»Šå‹•æ…‹ Pro</h4>
        <div class="d-flex gap-2">
            <input type="tel" id="inputTrain" class="form-control" placeholder="è¼¸å…¥è»Šæ¬¡ (ä¾‹ 408)" inputmode="numeric">
            <button id="searchBtn" class="btn btn-primary" style="min-width: 80px;">æŸ¥è©¢</button>
        </div>
    </div>

    <div id="mainArea" class="d-none">
        <div class="sticky-header shadow-sm" id="stickyHeader">
            <div class="d-flex justify-content-between align-items-center">
                <div style="overflow: hidden;">
                    <h5 class="m-0 fw-bold text-truncate" id="trainTitle">--</h5>
                    <small id="currentLocText" class="text-sub d-block text-truncate">è®€å–ä¸­...</small>
                </div>
                <span id="headerBadge" class="badge rounded-pill bg-secondary ms-2" style="white-space: nowrap;">--</span>
            </div>
        </div>

        <div class="card p-3">
            <h6 class="text-sub border-bottom pb-2 mb-3">è¡Œé§›å‹•æ…‹</h6>
            <div id="timeline" class="timeline-container"></div>
        </div>
    </div>
</div>

<div class="footer-info">
    <span id="footerTrain" class="fw-bold text-primary">--</span>
    <span class="footer-divider">|</span>
    <span id="footerLoc" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">--</span>
    <span class="footer-divider">|</span>
    <span id="lastUpdate" class="text-sub">--:--</span>
</div>

<div class="fab-container" id="fabContainer">
    <button class="fab-btn" data-bs-toggle="modal" data-bs-target="#settingsModal" id="fabBtn">
        <i class="bi bi-bell-fill"></i>
        <div class="fab-badge" id="fabBadge"></div>
    </button>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">ğŸ”” åˆ°ç«™æé†’èˆ‡åˆ†äº«</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="alert alert-light border mb-3">
                    <small class="text-muted d-block mb-1">é¸æ“‡ç›®çš„åœ°ï¼š</small>
                    <select id="destSelect" class="form-select form-select-lg mb-2"></select>
                    <div id="etaText" class="fw-bold text-primary mt-2">å°šæœªé¸æ“‡</div>
                </div>

                <button id="lineShareBtn" class="btn btn-line w-100 d-flex align-items-center justify-content-center gap-2 p-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0c4.411 0 8 2.912 8 6.492 0 1.433-.555 2.723-1.715 3.994-1.675 1.844-5.096 4.054-6.285 4.515-1.189.461-1.237-.311-1.237-.311l.129-2.028c-2.748-.076-5.892-1.786-5.892-6.17C0 2.912 3.59 0 8 0"/>
                    </svg>
                    LINE åˆ†äº«å³æ™‚ç‹€æ…‹
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    console.log("ç¨‹å¼é–‹å§‹è¼‰å…¥ (Ver: Footer-Update)...");

    let trainDB = {};
    let timer = null;
    let currentTrainNo = "";
    let notified = false;
    let firstLoad = true;
    let currentDelay = 0;

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchBtn').addEventListener('click', initApp);
        document.getElementById('destSelect').addEventListener('change', updateInfo);
        document.getElementById('lineShareBtn').addEventListener('click', shareToLine);
        loadDatabase();
    });

    async function loadDatabase() {
        try {
            const res = await fetch('train_db.json');
            if (!res.ok) throw new Error("æ‰¾ä¸åˆ° train_db.json");
            trainDB = await res.json();
            
            const params = new URLSearchParams(window.location.search);
            if(params.has('train')){
                document.getElementById('inputTrain').value = params.get('train');
                initApp();
                if(params.has('dest')){
                    setTimeout(() => {
                        const select = document.getElementById('destSelect');
                        select.value = params.get('dest');
                        updateInfo();
                    }, 800);
                }
            }
        } catch(e) {
            console.error(e);
            alert("âš ï¸ éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥æ™‚åˆ»è¡¨ (train_db.json)ã€‚");
        }
        if("Notification" in window) Notification.requestPermission();
    }

    function initApp() {
        const no = document.getElementById('inputTrain').value.trim();
        if(!no) return alert("è«‹è¼¸å…¥è»Šæ¬¡ï¼");
        if(!trainDB[no]) return alert("âŒ æŸ¥ç„¡æ­¤è»Šæ¬¡ï¼Œè«‹ç¢ºèªä»Šæ—¥æ˜¯å¦è¡Œé§›æˆ–æ›´æ–°æ™‚åˆ»è¡¨ã€‚");

        currentTrainNo = no;
        firstLoad = true;
        
        document.getElementById('mainArea').classList.remove('d-none');
        document.getElementById('stickyHeader').style.display = 'block';
        document.getElementById('fabContainer').style.display = 'block';
        document.getElementById('trainTitle').innerText = `${no} æ¬¡ ${trainDB[no].type}`;
        
        // æ›´æ–°åº•éƒ¨è»Šæ¬¡
        document.getElementById('footerTrain').innerText = `${no}æ¬¡`;

        const stops = trainDB[no].stops;
        const select = document.getElementById('destSelect');
        const currentVal = select.value;
        select.innerHTML = '<option value="">è«‹é¸æ“‡ç›®çš„åœ°...</option>';
        stops.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
        if(currentVal) select.value = currentVal;

        fetchLiveStatus();
        if(timer) clearInterval(timer);
        timer = setInterval(fetchLiveStatus, 60000); // æ”¹ç‚º 60 ç§’æ›´æ–°ä¸€æ¬¡
    }

    async function fetchLiveStatus() {
        const now = new Date();
        document.getElementById('lastUpdate').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        try {
            const res = await fetch(`/api/index?no=${currentTrainNo}`);
            if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");
            const data = await res.json();
            currentDelay = data.delay || 0;
            updateUI(data);
        } catch(e) {
            console.error("API Error", e);
            document.getElementById('currentLocText').innerText = "é€£ç·šç•°å¸¸ï¼Œé‡è©¦ä¸­...";
            document.getElementById('footerLoc').innerText = "é€£ç·šä¸­...";
        }
    }

    function updateUI(data) {
        const delay = data.delay || 0;
        const status = data.status || "not_started";
        const loc = data.loc || "æœªçŸ¥";
        const statusCode = data.statusCode || 4; // TDX: 0=é€²ç«™, 1=åœ¨ç«™, 2=é›¢ç«™

        const badge = document.getElementById('headerBadge');
        const locText = document.getElementById('currentLocText');
        
        // --- åº•éƒ¨ä½ç½®èˆ‡ Header æ›´æ–°é‚è¼¯ ---
        let displayLoc = loc;
        const stops = trainDB[currentTrainNo].stops;
        
        if (status === "not_started") {
            badge.innerText = "å°šæœªç™¼è»Š";
            badge.className = "badge rounded-pill bg-secondary ms-2";
            locText.innerText = "ç­‰å¾…ç™¼è»Šä¸­";
            displayLoc = "å°šæœªç™¼è»Š";
        } else {
            badge.innerText = delay > 0 ? `æ™š ${delay} åˆ†` : `æº–é»`;
            badge.className = `badge rounded-pill ms-2 ${delay > 0 ? 'bg-danger' : 'bg-success'}`;
            
            // â˜…â˜…â˜… å€é–“é¡¯ç¤ºæ ¸å¿ƒé‚è¼¯ â˜…â˜…â˜…
            // å¦‚æœç‹€æ…‹æ˜¯ 2 (é›¢ç«™ä¸­/è¡Œé§›ä¸­)ï¼Œä¸”ä¸æ˜¯æœ€å¾Œä¸€ç«™ï¼Œé¡¯ç¤º "æœ¬ç«™ â ä¸‹ä¸€ç«™"
            if (statusCode === 2) {
                const currentIdx = stops.findIndex(s => s.name === loc);
                if (currentIdx !== -1 && currentIdx < stops.length - 1) {
                    const nextStation = stops[currentIdx + 1].name;
                    displayLoc = `${loc} â ${nextStation}`;
                }
            }
            
            locText.innerText = `ä½ç½®ï¼š${displayLoc}`;
        }
        
        // æ›´æ–°åº•éƒ¨ä½ç½®æ–‡å­—
        document.getElementById('footerLoc').innerText = displayLoc;

        // --- ç¹ªè£½æ™‚é–“è»¸ ---
        let html = "";
        let passed = true; 
        let foundCurrent = false;
        let activeElementId = "";
        const now = new Date(); 

        stops.forEach((s, index) => {
            if(s.name === loc) foundCurrent = true;
            
            const [h, m] = s.time.split(':').map(Number);
            let date = new Date();
            date.setHours(h, m + delay, 0);

            if (now - date > 43200000) {
                date.setDate(date.getDate() + 1);
            }

            const etaStr = date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

            let statusClass = "";
            let rowId = `stop-${index}`;

            if(foundCurrent) { 
                passed = false; 
                statusClass = "active"; 
                foundCurrent = false; 
                activeElementId = rowId;
            } else if(passed && status !== "not_started") { 
                statusClass = "passed"; 
            }

            let delayHtml = "";
            if (status === "not_started") {
                delayHtml = `<span class="delay-tag bg-not-started">è¡¨å®š ${s.time}</span>`;
            } else if (delay > 0) {
                delayHtml = `<span class="delay-tag bg-delay-bad">æ™š ${delay} åˆ†</span>`;
            } else {
                delayHtml = `<span class="delay-tag bg-delay-ok">æº–é»</span>`;
            }

            html += `
                <div class="timeline-item ${statusClass}" id="${rowId}">
                    <div class="timeline-dot"></div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-main fs-5">${s.name}</span>
                        ${delayHtml}
                    </div>
                    <div class="text-sub small mt-1">
                        é è¨ˆ <span class="${statusClass === 'active' ? 'fw-bold text-primary' : ''}">${status === "not_started" ? s.time : etaStr}</span>
                    </div>
                </div>
            `;
            
            checkAlert(s.id, date, status);
        });

        document.getElementById('timeline').innerHTML = html;

        if (firstLoad && activeElementId && status !== "not_started") {
            setTimeout(() => {
                const el = document.getElementById(activeElementId);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
            firstLoad = false;
        }
    }

    function checkAlert(stopId, etaDate, status) {
        if (status === "not_started") return;

        const targetId = document.getElementById('destSelect').value;
        const etaTextDiv = document.getElementById('etaText');
        const fabBtn = document.getElementById('fabBtn');
        const fabBadge = document.getElementById('fabBadge');

        if(stopId == targetId) {
            const now = new Date();
            const diffMins = (etaDate - now) / 1000 / 60;
            const etaStr = etaDate.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
            
            if (diffMins > 60) {
                etaTextDiv.innerHTML = `é è¨ˆ <span class="text-primary">${etaStr}</span> æŠµé”`;
            } else if (diffMins > 0) {
                etaTextDiv.innerHTML = `é è¨ˆ ${etaStr} æŠµé”ï¼Œå‰© <span class="text-danger" style="font-size:1.4em">${Math.round(diffMins)}</span> åˆ†`;
            } else {
                etaTextDiv.innerHTML = `åˆ—è»Šå·²æŠµé”æˆ–é§›é›¢`;
            }

            fabBtn.classList.add('active');
            fabBadge.style.display = 'block';

            if(diffMins <= 5 && diffMins > 0 && !notified) {
                new Notification("ä¸‹è»Šæé†’", { body: `åˆ—è»Šå³å°‡æŠµé”ï¼Œè«‹æº–å‚™ä¸‹è»Šï¼` });
                if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
                alert("ğŸ”” æº–å‚™ä¸‹è»Šï¼");
                notified = true;
            }
        } else if (targetId === "") {
             fabBtn.classList.remove('active');
             fabBadge.style.display = 'none';
             etaTextDiv.innerText = "å°šæœªé¸æ“‡";
        }
    }

    function updateInfo() {
        notified = false; 
        fetchLiveStatus(); 
    }

    function shareToLine() {
        const select = document.getElementById('destSelect');
        const destIndex = select.selectedIndex;
        
        if (destIndex <= 0) {
            alert("è«‹å…ˆé¸æ“‡ç›®çš„åœ°ï¼Œæ‰èƒ½è¨ˆç®—æŠµé”æ™‚é–“å–”ï¼");
            return;
        }

        const destName = select.options[destIndex].text;
        const destId = select.value;
        const trainType = trainDB[currentTrainNo].type;
        const delayText = currentDelay > 0 ? `æ™š ${currentDelay} åˆ†` : "æº–é»";

        const stopData = trainDB[currentTrainNo].stops.find(s => s.id == destId);
        const [h, m] = stopData.time.split(':').map(Number);
        
        let date = new Date();
        const now = new Date();
        date.setHours(h, m + currentDelay, 0);

        if (now - date > 43200000) {
             date.setDate(date.getDate() + 1);
        }

        const eta = date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?train=${currentTrainNo}&dest=${destId}`;

        const msg = `æ­ä¹˜ ${currentTrainNo} åˆ—è»Š (${trainType})\n` +
                    `ç›®å‰ ${delayText}ï¼Œé è¨ˆ ${eta} æŠµé” ${destName}\n\n` +
                    `å³æ™‚å‹•æ…‹ï¼š\n${shareUrl}`;

        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`, '_blank');
    }
</script>
</body>
</html>
