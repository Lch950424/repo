<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šå‹•æ…‹ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #212529;
            --text-sub: #6c757d;
            --timeline-line: #dee2e6;
            --highlight: #0d6efd;
            --passed: #adb5bd;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --card-bg: #1e1e1e;
                --text-main: #e0e0e0;
                --text-sub: #a0a0a0;
                --timeline-line: #404040;
                --highlight: #6ea8fe;
                --passed: #4a4a4a;
            }
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main);
            padding-bottom: 80px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .card {
            background-color: var(--card-bg);
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            border-radius: 16px;
        }

        .form-control, .form-select, .btn {
            border-radius: 12px;
            height: 45px;
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
        }

        /* Sticky Header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 12px 15px;
            margin: 0 -12px 15px -12px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 0 0 16px 16px;
            display: none;
        }
        @media (prefers-color-scheme: dark) {
            .sticky-header {
                background-color: rgba(30, 30, 30, 0.85);
                border-bottom: 1px solid rgba(255,255,255,0.05);
            }
        }

        /* Timeline Styles */
        .timeline-container { position: relative; padding-left: 20px; }
        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 35px; border-left: 2px solid var(--timeline-line); }
        .timeline-item:last-child { border-left: transparent; }
        
        .timeline-dot {
            position: absolute; left: -6px; top: 5px;
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--card-bg); border: 2px solid var(--timeline-line);
            transition: all 0.3s;
        }

        .timeline-item.passed { border-left-color: var(--timeline-line); }
        .timeline-item.passed .timeline-dot { background: var(--passed); border-color: var(--passed); }
        .timeline-item.passed .text-main { color: var(--passed); text-decoration: line-through; }
        
        .timeline-item.active .timeline-dot { 
            width: 16px; height: 16px; left: -9px; top: 2px;
            background: var(--highlight); border-color: var(--highlight);
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.4);
        }
        .timeline-item.active .text-main { font-weight: bold; color: var(--highlight); font-size: 1.15rem; }

        .delay-tag { 
            font-size: 0.75rem; padding: 4px 8px; border-radius: 20px; font-weight: bold;
            display: inline-block; margin-left: 8px;
        }
        .bg-delay-ok { background-color: #d1e7dd; color: #0f5132; }
        .bg-delay-bad { background-color: #f8d7da; color: #842029; }
        .bg-not-started { background-color: #e2e3e5; color: #41464b; }

        .footer-info {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); padding: 10px;
            font-size: 0.75rem; text-align: center;
            border-top: 1px solid var(--timeline-line);
            color: var(--text-sub); z-index: 200;
        }
        
        .text-main { color: var(--text-main); }
        .text-sub { color: var(--text-sub); }
    </style>
</head>
<body>

<div class="container mt-3" style="max-width: 600px;">
    
    <div class="card p-3">
        <h4 class="mb-3 fw-bold">ğŸš„ åˆ—è»Šå‹•æ…‹ Pro</h4>
        <div class="d-flex gap-2">
            <input type="tel" id="inputTrain" class="form-control" placeholder="è¼¸å…¥è»Šæ¬¡ (ä¾‹ 408)" inputmode="numeric">
            <button id="searchBtn" class="btn btn-primary" style="min-width: 80px;">æŸ¥è©¢</button>
        </div>
    </div>

    <div id="mainArea" class="d-none">
        
        <div class="sticky-header shadow-sm" id="stickyHeader">
            <div class="d-flex justify-content-between align-items-center">
                <div style="overflow: hidden;">
                    <h5 class="m-0 fw-bold text-truncate" id="trainTitle">--</h5>
                    <small id="currentLocText" class="text-sub d-block text-truncate">è®€å–ä¸­...</small>
                </div>
                <span id="headerBadge" class="badge rounded-pill bg-secondary ms-2" style="white-space: nowrap;">--</span>
            </div>
        </div>

        <div class="card p-3">
            <label class="text-sub small mb-1 fw-bold">ğŸ”” åˆ°ç«™æé†’ (å‰ 5 åˆ†é˜)</label>
            <div class="d-flex gap-2">
                <select id="destSelect" class="form-select"></select>
                <button class="btn btn-outline-success" onclick="shareLink()">ğŸ“‹ åˆ†äº«</button>
            </div>
            <div id="etaText" class="mt-2 fw-bold text-main" style="min-height: 24px;"></div>
        </div>

        <div class="card p-3">
            <h6 class="text-sub border-bottom pb-2 mb-3">è¡Œé§›å‹•æ…‹</h6>
            <div id="timeline" class="timeline-container"></div>
        </div>
    </div>
</div>

<div class="footer-info">
    æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdate">--:--:--</span>
</div>

<script>
    console.log("ç¨‹å¼é–‹å§‹è¼‰å…¥...");

    // å…¨åŸŸè®Šæ•¸å®£å‘Š
    let trainDB = {};
    let timer = null;
    let currentTrainNo = "";
    let notified = false;
    let firstLoad = true;

    // 1. åˆå§‹åŒ–ç›£è½å™¨ (ç¢ºä¿æŒ‰éˆ•ä¸€å®šæ‰¾å¾—åˆ°å‡½å¼)
    document.addEventListener('DOMContentLoaded', function() {
        // ç¶å®šæŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
        document.getElementById('searchBtn').addEventListener('click', initApp);
        
        // ç¶å®šä¸‹æ‹‰é¸å–®è®Šæ›´äº‹ä»¶
        document.getElementById('destSelect').addEventListener('change', updateShareUrl);

        // è¼‰å…¥è³‡æ–™åº«
        loadDatabase();
    });

    // 2. è¼‰å…¥è³‡æ–™åº«
    async function loadDatabase() {
        try {
            const res = await fetch('train_db.json');
            if (!res.ok) throw new Error("æ‰¾ä¸åˆ° train_db.json");
            
            trainDB = await res.json();
            console.log("è³‡æ–™åº«è¼‰å…¥æˆåŠŸ");

            // æª¢æŸ¥ç¶²å€åƒæ•¸ (åˆ†äº«é€£çµç”¨)
            const params = new URLSearchParams(window.location.search);
            if(params.has('train')){
                document.getElementById('inputTrain').value = params.get('train');
                initApp();
                if(params.has('dest')){
                    setTimeout(() => {
                        const select = document.getElementById('destSelect');
                        select.value = params.get('dest');
                        updateShareUrl(); 
                    }, 800); // ç¨å¾®å»¶é²ç¢ºä¿ DOM å»ºç«‹
                }
            }
        } catch(e) {
            console.error("è¼‰å…¥å¤±æ•—:", e);
            alert("âš ï¸ éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥æ™‚åˆ»è¡¨ (train_db.json)ã€‚è«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å·²ä¸Šå‚³åˆ° GitHubã€‚");
        }
        
        if("Notification" in window) Notification.requestPermission();
    }

    // 3. ä¸»ç¨‹å¼ï¼šåˆå§‹åŒ–ä»‹é¢
    function initApp() {
        const no = document.getElementById('inputTrain').value.trim();
        if(!no) return alert("è«‹è¼¸å…¥è»Šæ¬¡ï¼");
        if(!trainDB[no]) return alert("âŒ æŸ¥ç„¡æ­¤è»Šæ¬¡ï¼Œè«‹ç¢ºèªä»Šæ—¥æ˜¯å¦è¡Œé§›æˆ–æ›´æ–°æ™‚åˆ»è¡¨ã€‚");

        currentTrainNo = no;
        firstLoad = true;
        
        // é¡¯ç¤ºä»‹é¢
        document.getElementById('mainArea').classList.remove('d-none');
        document.getElementById('stickyHeader').style.display = 'block';
        document.getElementById('trainTitle').innerText = `${no} æ¬¡ ${trainDB[no].type}`;
        
        // å¡«å…¥ä¸‹æ‹‰é¸å–®
        const stops = trainDB[no].stops;
        const select = document.getElementById('destSelect');
        const currentVal = select.value;
        select.innerHTML = '<option value="">é¸æ“‡ä¸‹è»Šç«™...</option>';
        stops.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
        // å˜—è©¦ä¿ç•™åŸæœ¬é¸æ“‡
        if(currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
            select.value = currentVal;
        }

        // ç«‹å³åŸ·è¡Œä¸¦è¨­å®šè¼ªè©¢
        fetchLiveStatus();
        if(timer) clearInterval(timer);
        timer = setInterval(fetchLiveStatus, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡
    }

    // 4. API æŸ¥è©¢
    async function fetchLiveStatus() {
        const now = new Date();
        document.getElementById('lastUpdate').innerText = now.toLocaleTimeString();

        try {
            const res = await fetch(`/api/index?no=${currentTrainNo}`);
            if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");
            
            const data = await res.json();
            updateUI(data);
        } catch(e) {
            console.error("API Error", e);
            document.getElementById('currentLocText').innerText = "é€£ç·šç•°å¸¸ï¼Œé‡è©¦ä¸­...";
        }
    }

    // 5. æ›´æ–°ç•«é¢ (UI)
    function updateUI(data) {
        const delay = data.delay || 0;
        const status = data.status || "not_started";
        const loc = data.loc || "æœªçŸ¥";

        // æ›´æ–° Header ç‹€æ…‹
        const badge = document.getElementById('headerBadge');
        const locText = document.getElementById('currentLocText');
        
        if (status === "not_started") {
            badge.innerText = "å°šæœªç™¼è»Š";
            badge.className = "badge rounded-pill bg-secondary ms-2";
            locText.innerText = "ç­‰å¾…ç™¼è»Šä¸­";
        } else {
            badge.innerText = delay > 0 ? `æ™š ${delay} åˆ†` : `æº–é»`;
            badge.className = `badge rounded-pill ms-2 ${delay > 0 ? 'bg-danger' : 'bg-success'}`;
            locText.innerText = `ç›®å‰ä½ç½®ï¼š${loc}`;
        }

        // ç¹ªè£½æ™‚é–“è»¸
        const stops = trainDB[currentTrainNo].stops;
        let html = "";
        let passed = true; 
        let foundCurrent = false;
        let activeElementId = "";

        stops.forEach((s, index) => {
            if(s.name === loc) foundCurrent = true;
            
            // è¨ˆç®— ETA
            const [h, m] = s.time.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m + delay, 0);
            const etaStr = date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

            // ç‹€æ…‹ CSS
            let statusClass = "";
            let rowId = `stop-${index}`;

            if(foundCurrent) { 
                passed = false; 
                statusClass = "active"; 
                foundCurrent = false; 
                activeElementId = rowId;
            } else if(passed && status !== "not_started") { 
                statusClass = "passed"; 
            }

            // èª¤é»æ¨™ç±¤
            let delayHtml = "";
            if (status === "not_started") {
                delayHtml = `<span class="delay-tag bg-not-started">è¡¨å®š ${s.time}</span>`;
            } else if (delay > 0) {
                delayHtml = `<span class="delay-tag bg-delay-bad">æ™š ${delay} åˆ†</span>`;
            } else {
                delayHtml = `<span class="delay-tag bg-delay-ok">æº–é»</span>`;
            }

            html += `
                <div class="timeline-item ${statusClass}" id="${rowId}">
                    <div class="timeline-dot"></div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-main fs-5">${s.name}</span>
                        ${delayHtml}
                    </div>
                    <div class="text-sub small mt-1">
                        é è¨ˆ <span class="${statusClass === 'active' ? 'fw-bold text-primary' : ''}">${status === "not_started" ? s.time : etaStr}</span>
                    </div>
                </div>
            `;
            
            checkAlert(s.id, date, status);
        });

        document.getElementById('timeline').innerHTML = html;

        // è‡ªå‹•æ²å‹• (åªåœ¨åˆæ¬¡è¼‰å…¥ä¸”å·²ç™¼è»Šæ™‚åŸ·è¡Œ)
        if (firstLoad && activeElementId && status !== "not_started") {
            setTimeout(() => {
                const el = document.getElementById(activeElementId);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
            firstLoad = false;
        }
    }

    // 6. æª¢æŸ¥é€šçŸ¥
    function checkAlert(stopId, etaDate, status) {
        if (status === "not_started") return;

        const targetId = document.getElementById('destSelect').value;
        if(stopId !== targetId) return;

        const now = new Date();
        const diffMins = (etaDate - now) / 1000 / 60;
        
        const etaStr = etaDate.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        const etaTextDiv = document.getElementById('etaText');
        
        if (diffMins > 60) {
            etaTextDiv.innerHTML = `é è¨ˆ ${etaStr} æŠµé”`;
        } else if (diffMins > 0) {
            etaTextDiv.innerHTML = `é è¨ˆ ${etaStr} æŠµé”ï¼Œå‰© <span class="text-danger" style="font-size:1.4em">${Math.round(diffMins)}</span> åˆ†`;
        } else {
            etaTextDiv.innerHTML = `åˆ—è»Šå·²æŠµé”æˆ–é§›é›¢`;
        }

        if(diffMins <= 5 && diffMins > 0 && !notified) {
            new Notification("ä¸‹è»Šæé†’", { body: `åˆ—è»Šå³å°‡æŠµé”ï¼Œè«‹æº–å‚™ä¸‹è»Šï¼` });
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
            alert("ğŸ”” æº–å‚™ä¸‹è»Šï¼");
            notified = true;
        }
    }

    // 7. åˆ†äº«åŠŸèƒ½
    function updateShareUrl() {
        notified = false; 
        fetchLiveStatus(); 
    }

    function shareLink() {
        const dest = document.getElementById('destSelect').value;
        const url = `${window.location.origin}${window.location.pathname}?train=${currentTrainNo}&dest=${dest}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'åˆ—è»Šå‹•æ…‹',
                text: `æˆ‘æ­ä¹˜çš„ ${currentTrainNo} æ¬¡åˆ—è»Š`,
                url: url,
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url).then(() => alert("é€£çµå·²è¤‡è£½ï¼"));
        }
    }
</script>
</body>
</html>
